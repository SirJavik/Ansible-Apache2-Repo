####################################
##### MANAGED BY ANSIBLE ({{ ansible_role_name }})
####################################
#########################################
#            _             _ _          #
#           | |           (_) |         #
#           | | __ ___   ___| | __      #
#       _   | |/ _` \ \ / / | |/ /      #
#      | |__| | (_| |\ V /| |   <       #
#       \____/ \__,_| \_/ |_|_|\_\      #
#                                       #
######################################### 

{% if 'redirect_to_https' in vhost and vhost.redirect_to_https == true %}
<VirtualHost *:80> 
    ServerName {{ vhost.host }}
    Redirect permanent / https://{{ vhost.host }}
</VirtualHost>
{% if 'alias' in vhost %}  
<VirtualHost *:80> 
    ServerName {{ vhost.alias }}
    Redirect permanent / https://{{ vhost.alias }}
</VirtualHost> 
{% endif %}
{% else %}
<VirtualHost *:80>
    ServerName {{ vhost.host }}
{% if 'alias' in vhost %}   
    ServerAlias {{ vhost['alias'] }}
{% endif %}

    DocumentRoot {{ vhost.root }}
    DirectoryIndex {{ vhost['directoryindex'] if 'directoryindex' in vhost else 'index.php index.html' }}

    <Directory {{ vhost.root }}>
        Options {{ vhost['root_options'] if 'root_options' in vhost else 'FollowSymLinks' }}
        AllowOverride {{ vhost['root_allowoverride'] if 'root_allowoverride' in vhost else 'None' }}
        Require all granted
    </Directory>
    Header set X-Hostname {{ vhost.host }}
</VirtualHost>
{% endif %}

{% if 'https' in vhost and vhost.https == true %}
<IfModule ssl_module>
    <VirtualHost *:443>
        ServerName {{ vhost.host -}}
{%- if 'alias' in vhost %}   
        ServerAlias {{ vhost.alias }}
{% endif %}
        DocumentRoot {{ vhost.root }}
        DirectoryIndex {{ vhost['directoryindex'] if 'directoryindex' in vhost else 'index.php index.html' }}

        <Directory {{ vhost.root }}>
            Options {{ vhost['root_options'] if 'root_options' in vhost else 'FollowSymLinks' }}
            AllowOverride {{ vhost['root_allowoverride'] if 'root_allowoverride' in vhost else 'None' }}
            Require all granted
        </Directory>
        Header set X-Hostname {{ vhost.host }}

        SSLEngine on
        SSLCertificateFile {{ vhost.cert }}
        SSLCertificateKeyFile {{ vhost.privkey }}
        #SSLCertificateChainFile /etc/letsencrypt/live/{{ vhost.host }}/chain.pem
    </VirtualHost>
</IfModule>
{% endif %}
